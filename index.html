<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Protocol Generator: QI or IRB</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.47.1/docxtemplater.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            background-color: #eff6ff;
        }
        .step-indicator.active {
            background-color: #3b82f6;
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto bg-white shadow-xl rounded-xl p-6 sm:p-10">
        
        <!-- Back Button & Header -->
        <div class="flex items-center justify-between mb-8">
            <button id="backButton" onclick="goBack()" class="flex items-center text-gray-600 hover:text-blue-600 transition duration-150 rounded-full p-2 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span class="ml-2 font-medium hidden sm:inline">Back</span>
            </button>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800">Protocol Assistant</h1>
            <div class="w-16"></div> <!-- Spacer -->
        </div>

        <!-- Status/Notification Message -->
        <div id="messageBox" class="hidden p-4 mb-6 text-sm rounded-lg" role="alert"></div>

        <!-- Main Content Area -->
        <div id="contentArea">
            <!-- Screen 1: Project Type Selection -->
            <div id="screen-type-selection" class="space-y-6">
                <h2 class="text-xl font-semibold text-gray-700 mb-6">Step 1: Choose Your Project Type</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button onclick="selectType('QI')" class="flex flex-col items-center p-8 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:shadow-lg transition duration-300">
                        <span class="text-lg font-bold text-gray-800">Quality Improvement (QI)</span>
                        <p class="text-gray-500 text-sm mt-1 text-center">Focuses on improving local processes, patient safety, or efficiency (e.g., PDSA cycle).</p>
                    </button>
                    <button onclick="selectType('IRB')" class="flex flex-col items-center p-8 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:shadow-lg transition duration-300">
                        <span class="text-lg font-bold text-gray-800">Research (IRB Protocol)</span>
                        <p class="text-gray-500 text-sm mt-1 text-center">Systematic investigation designed to develop or contribute to generalizable knowledge.</p>
                    </button>
                </div>
            </div>

            <!-- Screen 2: QI Form (PDSA) -->
            <div id="screen-qi-form" class="hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-6">Quality Improvement Protocol (PDSA)</h2>
                <div class="space-y-6">
                    <div class="p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg">
                        <p class="text-sm text-yellow-700 font-medium">Please provide *minimum* details. The AI will complete the remaining sections for you.</p>
                    </div>

                    <!-- PDSA - Plan -->
                    <div class="border p-4 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">I. Identify & Plan (Minimum Required)</h3>
                        <label class="block mb-4">
                            <span class="text-gray-700 font-medium">Project Title:</span>
                            <input type="text" id="qi-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2" placeholder="e.g., Reducing Post-Op Sepsis Rates">
                        </label>
                        <label class="block mb-4">
                            <span class="text-gray-700 font-medium">Problem Statement (Quantified):</span>
                            <textarea id="qi-problem" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2" placeholder="e.g., Our post-op sepsis rate is 8%, which is 3% higher than the national average of 5%."></textarea>
                        </label>
                        <label class="block mb-4">
                            <span class="text-gray-700 font-medium">Aim Statement (SMART Goal):</span>
                            <textarea id="qi-aim" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2" placeholder="e.g., We aim to reduce the post-op sepsis rate from 8% to 6% by Q4 2024."></textarea>
                        </label>
                        <label class="block mb-4">
                            <span class="text-gray-700 font-medium">Key Intervention (The Change):</span>
                            <textarea id="qi-intervention" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2" placeholder="e.g., Implementation of a new 5-point 'Sepsis Alert' checklist in the PACU."></textarea>
                        </label>
                    </div>

                    <button onclick="generateProtocol('QI')" id="qi-submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-300 shadow-md flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" id="qi-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Generate & Download Protocol
                    </button>
                </div>
            </div>

            <!-- Screen 3: IRB Form -->
            <div id="screen-irb-form" class="hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-6">IRB Protocol Application (Research)</h2>
                <div class="space-y-6">
                    <div class="p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded-r-lg">
                        <p class="text-sm text-yellow-700 font-medium">Complete the minimum required fields, then use the Power Analysis tool, and let the AI draft the document.</p>
                    </div>

                    <!-- Minimal Required Fields -->
                    <div class="border p-4 rounded-lg bg-gray-50">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">I. Research Core Information</h3>
                        <label class="block mb-4">
                            <span class="text-gray-700 font-medium">Protocol Title:</span>
                            <input type="text" id="irb-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2" placeholder="e.g., A Randomized Trial on Early Mobility after Hip Surgery">
                        </label>
                        <label class="block mb-4">
                            <span class="text-gray-700 font-medium">Objective / Study Question:</span>
                            <textarea id="irb-objective" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2" placeholder="e.g., To determine if an early mobility protocol (starting within 12 hours) reduces hospital stay compared to standard care (starting at 24 hours) in patients >65 years old."></textarea>
                        </label>
                        <label class="block mb-4">
                            <span class="text-gray-700 font-medium">Target Population:</span>
                            <input type="text" id="irb-population" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2" placeholder="e.g., Patients over 65 years undergoing elective total hip arthroplasty.">
                        </label>
                        <label class="block mb-4">
                            <span class="text-gray-700 font-medium">Key Procedures / Interventions:</span>
                            <textarea id="irb-procedures" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2" placeholder="e.g., Randomized to Group A (mobility at 12h) vs. Group B (mobility at 24h). Outcome data (LOS, pain scores) collected daily."></textarea>
                        </label>
                        <label class="block mb-4">
                            <span class="text-gray-700 font-medium">Calculated Sample Size (from below):</span>
                            <input type="number" id="irb-sample-size" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring focus:ring-blue-500 focus:ring-opacity-50 p-2" placeholder="Automatically filled by Power Analysis">
                        </label>
                    </div>

                    <!-- Power Analysis -->
                    <div class="border p-4 rounded-lg bg-indigo-50">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4 flex justify-between items-center">
                            II. Power Analysis Calculator (Research Only)
                        </h3>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <label class="block">
                                <span class="text-gray-700 text-sm font-medium">Alpha (Significance Level - e.g., 0.05):</span>
                                <input type="number" id="pa-alpha" value="0.05" step="0.01" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 text-sm font-medium">Power (e.g., 0.80):</span>
                                <input type="number" id="pa-power" value="0.80" step="0.05" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </label>
                            <label class="block">
                                <span class="text-gray-700 text-sm font-medium">Effect Size (Cohen's d, e.g., 0.5):</span>
                                <input type="number" id="pa-effect" value="0.5" step="0.1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                            </label>
                            <div class="flex items-end">
                                <button onclick="calculatePower()" class="w-full bg-indigo-500 text-white py-2 rounded-lg font-semibold hover:bg-indigo-600 transition duration-300 shadow-md">
                                    Calculate Sample Size
                                </button>
                            </div>
                        </div>
                        <div id="pa-result" class="mt-4 p-3 bg-indigo-100 rounded-lg text-indigo-800 hidden font-medium"></div>
                        <p class="text-xs text-gray-500 mt-2">Note: This is an estimation for a two-sample t-test (two groups). Effect size guides: Small=0.2, Medium=0.5, Large=0.8.</p>
                    </div>

                    <button onclick="generateProtocol('IRB')" id="irb-submit" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition duration-300 shadow-md flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" id="irb-spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Generate & Download Protocol
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- Hidden Templates - Base64 encoded Word documents -->
    <script>
        // --- BASE64 TEMPLATES FOR DOCX GENERATION ---

        // QI TEMPLATE (Simplified PDSA structure)
        const QI_TEMPLATE_BASE64 = `
            UFJPVFPDQ09MIFRZUEU6IFF1YWxpdHkgSW1wcm92ZW1lbnQgSW5pdGlhdGl2ZQoKUFJPSkVDVCBU
            SVRMRTogICB7dGl0bGV9CgpJLiBQIChQTEFOKSAtIFBsYW4KCkJhc2ljIElkZW50aWZpY2F0aW9u
            CgpQcm9ibGVtIFN0YXRlbWVudDogIHtxdWFuX3Byb2JsZW19CgogQWltIFN0YXRlbWVudCAoU01B
            UlQgR29hbCk6ICB7YWltfQoKIEtleSBJbnRlcnZlbnRpb24vQ2hhbmdlOiAge2ludGVydmVudGlv
            bn0KCiBETlM6IFsge2FpX2Ruc30gXQoKIEJldHRlciBCYWNrZ3JvdW5kICYgUmF0aW9uYWxlOgoK
            IHthYV9iYWNrZ3JvdW5kfQoKSUkuIERPIChETykgLSBJbXBsZW1lbnRhdGlvbiBQbGFuCgogeyBh
            aV9kb30KCiBJSUkuIFMgKFNUVURZKSAtIERhdGEgQ29sbGVjdGlvbiAmIEFuYWx5c2lzCgogeyBh
            aV9zdHVkeX0KCiBJVi4gQSAoQUNUKTogU3VzdGFpbm1lbnQgJiBOZXh0IFN0ZXBzCgogeyBhYV9h
            Y3R9CgpSZXN1bHRzIGFuZCBGaW5kaW5nczogCiBbeyByZXN1bHRzIH0KCkFkZGl0aW9uYWwgQ29t
            bWVudHM6IFthZGRpdGlvbmFsX2NvbW1lbnRzXQoKUFJlcGFyZWQgYnkgQUkgUHJvdG9jb2wgQXNz
            aXN0YW50Lg==
        `;

        // IRB TEMPLATE (Detailed Research structure, uses full IRB template as a placeholder for complexity)
        const IRB_TEMPLATE_BASE64 = `
            UFJPVFBDQ09MIFRZUEU6IFJlc2VhcmNoIC0gSUJSIFByb3RvY29sCgpQUk9UT0NPTCBUSVRMRTogICB7aXJiX3RpdGxlfQoKSUkuIENvcmUgUmVzZWFyY2ggSW5mb3JtYXRpb24KCiBPYmplY3RpdmUvU3R1ZHkgUXVlc3Rpb246IHtpcmJfb2JqZWN0aXZlfQoKIFRhcmdldCBQb3B1bGF0aW9uOiB7aXJiX3BvcHVsYXRpb259CgogS2V5IFByb2NlZHVyZXMvSW50ZXJ2ZW50aW9ucjoge2lyYl9wcm9jZWR1cmVzfQoKIFNhbXBsZSBTaXplIChUb3RhbCk6IHtpcmJfc2FtcGxlX3NpemV9CgoxLiBCYWNrZ3JvdW5kIGFuZCBSYXRpb25hbGUgKElSQiBQYXJ0ICgyYykpCgogV2h5IGlzIHRoaXMgaW1wb3J0YW50PyBXaGF0IGRvIHdlIGtub3cgYWxyZWFkeT8KCiB7YWFfYmFja2dyb3VuZH0KCiAyLiBNZXRob2RvbG9neSBhbmQgU3R1ZHkgRGVzaWduIChJUkIgUGFydCAoMmQpKQoKIERldGFpbGVkIFN0dWR5IERlc2lnbiwgRGF0YSBDb2xsZWN0aW9uLCBhbmQgRGF0YSBBbmFseXNpczogCgogIHthYV9tZXRob2RzfQoKIDMuIFJpc2tzIGFuZCBCZW5lZml0cyAoSVJCIFBhcnQgKDJlLCgyZikpCgogIENvbXByZWhlbnNpdmUgUmlzay9CZW5lZml0IEFzc2Vzc21lbnQ6CgogIHthYV9yaXNrYmVuZWZpdH0KCiA0LiBQb3B1bGF0aW9uIGFuZCBTYW1wbGUgU2l6ZSBKdXN0aWZpY2F0aW9uIChJUkIgUGFydCAoMmcpKQoKIFNhbXBsZSBTaXplIEp1c3RpZmljYXRpb24gJmMgQWNjcnVhbCBQbGFuOgogCiBbeyBhYV9zYW1wbGVfanVzdGlmaWNhdGlvbiB9CgogIFJlcXVpcmVkIExvZ2ljOiAgIFt7YWFfcmVxdWlyZWRfbG9naWN9XQoKIFByZXBhcmVkIGJ5IEFJIFByb3RvY29sIEFzc2lzdGFudC4=
        `;

        // Utility function to convert Base64 string to ArrayBuffer for docxtemplater
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64.trim());
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // --- NAVIGATION LOGIC ---
        let historyStack = ['screen-type-selection'];
        const apiKey = ""; // Canvas will provide this
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        function goBack() {
            if (historyStack.length > 1) {
                historyStack.pop();
                const prevScreenId = historyStack[historyStack.length - 1];
                showScreen(prevScreenId, true); // Don't push back again
            }
        }

        function showScreen(screenId, isBack = false) {
            document.querySelectorAll('#contentArea > div').forEach(el => el.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');

            if (!isBack && historyStack[historyStack.length - 1] !== screenId) {
                historyStack.push(screenId);
            }

            // Update back button state
            document.getElementById('backButton').disabled = historyStack.length <= 1;
        }

        function selectType(type) {
            if (type === 'QI') {
                showScreen('screen-qi-form');
            } else if (type === 'IRB') {
                showScreen('screen-irb-form');
            }
        }

        // --- POWER ANALYSIS (Sample Size Calculation) ---
        function calculatePower() {
            const alpha = parseFloat(document.getElementById('pa-alpha').value);
            const power = parseFloat(document.getElementById('pa-power').value);
            const d = parseFloat(document.getElementById('pa-effect').value); // Cohen's d

            const paResultEl = document.getElementById('pa-result');
            paResultEl.classList.remove('hidden');
            paResultEl.className = 'mt-4 p-3 bg-red-100 rounded-lg text-red-800 font-medium';
            paResultEl.innerHTML = 'Calculating...';

            if (isNaN(alpha) || isNaN(power) || isNaN(d) || alpha <= 0 || power <= 0 || power >= 1 || d <= 0) {
                paResultEl.innerHTML = 'Please enter valid values for Alpha (0-1), Power (0-1), and Effect Size (d > 0).';
                return;
            }

            // Z-score approximations for common values (for a two-tailed test, z_alpha/2)
            // and z_beta (for 1-beta)
            // This is a simplified lookup/approximation for the formula N = (2 * (Z_alpha + Z_power)^2) / d^2
            const Z_ALPHA_MAP = { 0.05: 1.96 }; 
            const Z_POWER_MAP = { 0.80: 0.84, 0.90: 1.28 }; 

            const Z_alpha = Z_ALPHA_MAP[alpha] || 1.96; 
            const Z_power = Z_POWER_MAP[power] || 0.84; 

            // Formula for sample size per group for two-sample t-test (rounded up)
            const N_per_group_float = (2 * Math.pow(Z_alpha + Z_power, 2)) / Math.pow(d, 2);
            const N_per_group = Math.ceil(N_per_group_float);
            const totalN = N_per_group * 2;

            document.getElementById('irb-sample-size').value = totalN;

            paResultEl.className = 'mt-4 p-3 bg-indigo-100 rounded-lg text-indigo-800 font-medium';
            paResultEl.innerHTML = `Required Sample Size: <strong>${totalN} total</strong> participants (${N_per_group} per group). This value has been automatically added to the form.`;

            // Clear any error messages
            document.getElementById('messageBox').classList.add('hidden');
        }

        // --- AI GENERATION & DOCUMENT DOWNLOAD ---
        async function generateProtocol(type) {
            const submitBtn = document.getElementById(`${type.toLowerCase()}-submit`);
            const spinner = document.getElementById(`${type.toLowerCase()}-spinner`);
            const messageBox = document.getElementById('messageBox');

            // 1. Get Form Data
            let formData = {};
            let templateBase64;
            let protocolName;
            let systemPrompt;

            if (type === 'QI') {
                formData = {
                    title: document.getElementById('qi-title').value,
                    problem: document.getElementById('qi-problem').value,
                    aim: document.getElementById('qi-aim').value,
                    intervention: document.getElementById('qi-intervention').value,
                };
                templateBase64 = QI_TEMPLATE_BASE64;
                protocolName = formData.title || "QI_Protocol_Draft";
                systemPrompt = `You are a Quality Improvement (QI) expert. Based on the minimal user input, generate the remaining sections of a comprehensive PDSA (Plan, Do, Study, Act) protocol. The output MUST be a single JSON object.

Input Data:
Project Title: ${formData.title}
Problem Statement: ${formData.problem}
Aim Statement: ${formData.aim}
Key Intervention: ${formData.intervention}

Tasks:
1. Generate 'ai_background': Detailed background, literature review, and rationale for the QI project.
2. Generate 'ai_do': Specific, step-by-step plan for implementing the intervention (the 'Do' phase), including timeline and team roles.
3. Generate 'ai_study': Detailed plan for data collection, key metrics (process, outcome, balancing), and analysis methods for the 'Study' phase.
4. Generate 'ai_act': Plan for standardizing the change, spreading it, or determining the next PDSA cycle (the 'Act' phase).
5. Generate a 'ai_dns' (Detailed next steps)
6. Generate 'results': A placeholder result like 'Data collection is ongoing...'.
7. Generate 'additional_comments': Any necessary disclosure or assumption comments.

Ensure all fields are detailed and professionally written.`;

            } else if (type === 'IRB') {
                formData = {
                    irb_title: document.getElementById('irb-title').value,
                    irb_objective: document.getElementById('irb-objective').value,
                    irb_population: document.getElementById('irb-population').value,
                    irb_procedures: document.getElementById('irb-procedures').value,
                    irb_sample_size: document.getElementById('irb-sample-size').value,
                };
                templateBase64 = IRB_TEMPLATE_BASE64;
                protocolName = formData.irb_title || "IRB_Protocol_Draft";
                systemPrompt = `You are a Clinical Research Coordinator and IRB protocol specialist. Based on the minimal user input, generate the remaining sections of a comprehensive IRB Research Protocol. The output MUST be a single JSON object.

Input Data:
Protocol Title: ${formData.irb_title}
Objective/Question: ${formData.irb_objective}
Target Population: ${formData.irb_population}
Key Procedures: ${formData.irb_procedures}
Sample Size (Total N): ${formData.irb_sample_size}

Tasks:
1. Generate 'aa_background': A detailed, literature-backed introduction and rationale (IRB Part 2c).
2. Generate 'aa_methods': Detailed methodology, including study design (e.g., randomized controlled trial), specific data collection procedures, statistical analysis plan (IRB Part 2d).
3. Generate 'aa_riskbenefit': A comprehensive assessment of risks to subjects, methods for minimizing risks, and anticipated benefits (IRB Parts 2e, 2f).
4. Generate 'aa_sample_justification': Detailed justification for the sample size, including the power analysis (if provided), accrual plan, and inclusion/exclusion criteria (IRB Part 2g).
5. Generate 'aa_required_logic': Required logic for the study.

Ensure all fields are detailed, scientifically rigorous, and formatted with proper academic section headings/bullet points where appropriate.`;
            }

            // Basic validation
            if (Object.values(formData).some(val => !val)) {
                showMessage('error', 'Please fill out all the required fields before generating the protocol.');
                return;
            }

            // 2. Setup UI for Loading
            submitBtn.disabled = true;
            spinner.classList.remove('hidden');
            messageBox.classList.add('hidden');
            showMessage('info', 'AI is drafting your protocol... this may take up to 30 seconds.');


            // 3. API Call Configuration
            const userQuery = `Fill in the detailed protocol sections based on this data: ${JSON.stringify(formData)}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            aa_background: { type: "STRING" },
                            aa_methods: { type: "STRING" },
                            aa_riskbenefit: { type: "STRING" },
                            aa_sample_justification: { type: "STRING" },
                            aa_required_logic: { type: "STRING" }, // IRB-specific placeholder
                            ai_do: { type: "STRING" }, // QI-specific placeholder
                            ai_study: { type: "STRING" }, // QI-specific placeholder
                            ai_act: { type: "STRING" }, // QI-specific placeholder
                            ai_dns: { type: "STRING" }, // QI-specific placeholder
                            results: { type: "STRING" }, // QI-specific placeholder
                            additional_comments: { type: "STRING" } // QI-specific placeholder
                        }
                    }
                }
            };

            // 4. Execute API Call with Exponential Backoff
            let responseData = null;
            const maxRetries = 5;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonText) throw new Error("AI returned no parsable JSON content.");

                    responseData = JSON.parse(jsonText);
                    break; // Success
                } catch (error) {
                    if (i === maxRetries - 1) {
                        console.error('API call failed after max retries:', error);
                        showMessage('error', `Protocol generation failed: ${error.message}. Please check your inputs or try again.`);
                        return;
                    }
                    const delay = Math.pow(2, i) * 1000;
                    // Exponential backoff delay
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }


            // 5. Merge Data and Download
            try {
                // Combine form data with AI-generated data
                const docData = { ...formData, ...responseData };

                // Handle null/undefined data safely
                Object.keys(docData).forEach(key => {
                    if (docData[key] === null || docData[key] === undefined) {
                        docData[key] = '';
                    }
                });

                const content = base64ToArrayBuffer(templateBase64);
                const zip = new JSZip(content);
                const doc = new docxtemplater().loadZip(zip);

                doc.setData(docData);
                doc.render();

                const out = doc.getZip().generate({
                    type: "blob",
                    mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                });
                
                // Trigger download
                saveAs(out, `${protocolName.replace(/[^a-z0-9]/gi, '_')}.docx`);
                showMessage('success', `Success! Your protocol "${protocolName}" has been generated and downloaded. Don't forget to review and edit the draft!`);

            } catch (error) {
                console.error('DOCX generation or rendering failed:', error);
                showMessage('error', `DOCX generation failed: ${error.message}. Please try again.`);
            } finally {
                // 6. Reset UI
                submitBtn.disabled = false;
                spinner.classList.add('hidden');
            }
        }

        // --- MESSAGE HANDLER ---
        function showMessage(type, message) {
            const messageBox = document.getElementById('messageBox');
            messageBox.innerHTML = message;
            messageBox.classList.remove('hidden', 'bg-red-100', 'bg-green-100', 'bg-blue-100', 'text-red-800', 'text-green-800', 'text-blue-800');

            if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'text-red-800');
            } else { // info/loading
                messageBox.classList.add('bg-blue-100', 'text-blue-800');
            }
        }

        // Initialize view on load
        document.addEventListener('DOMContentLoaded', () => {
            showScreen('screen-type-selection', true);
        });

    </script>
</body>
</html>
